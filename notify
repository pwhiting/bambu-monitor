#!/usr/bin/env python3
"""
Send notifications via Pushcut webhook.
Triggers notification for each line read from stdin.
Free version - no custom text.
"""
import sys
import os
import argparse
import requests

def log(msg):
    """Log to stderr with script name prefix"""
    print(f"{sys.argv[0]}: {msg}", file=sys.stderr)

def send_notification(webhook_secret, notification_name):
    """Send notification via Pushcut webhook"""
    try:
        url = f"https://api.pushcut.io/{webhook_secret}/notifications/{notification_name}"
        
        log(f"Triggering notification: {notification_name}")
        
        response = requests.post(url, json={})
        response.raise_for_status()
        
        log("Notification sent successfully")
        return True
        
    except Exception as e:
        log(f"Error sending notification: {e}")
        return False

def main():
    parser = argparse.ArgumentParser(
        description="Send notifications via Pushcut webhook (reads from stdin)"
    )
    parser.add_argument(
        "notification",
        help="Pushcut notification name to trigger"
    )
    
    args = parser.parse_args()
    
    # Get webhook secret from environment
    webhook_secret = os.getenv("PUSHCUT_WEBHOOK_SECRET")
    if not webhook_secret:
        log("Error: PUSHCUT_WEBHOOK_SECRET environment variable not set")
        sys.exit(1)
    
    # Read from stdin and trigger notification for each line
    for line in sys.stdin:
        value = line.strip()
        
        if not value:
            continue
        
        # Trigger the notification
        if send_notification(webhook_secret, args.notification):
            # Echo the input to stdout for further pipeline processing
            print(value)
            sys.stdout.flush()
        else:
            sys.exit(1)

if __name__ == "__main__":
    main()
